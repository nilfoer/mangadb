<!doctype html>
{% if book %}
<title>{{ book.title if book.title else 'New Book' + ' - MangaDB' }}</title>
{% else %}
<title>MangaDB</title>
{% endif %}
<link rel=stylesheet type=text/css href="{{ url_for('static', filename='fontawesome-all.min.css') }}">
<link rel=stylesheet type=text/css href="{{ url_for('static', filename='bootstrap.min.css') }}">
<link rel=stylesheet type=text/css href="{{ url_for('static', filename='style.css') }}">
{# src https://appelsiini.net/projects/lazyload or https://github.com/tuupola/jquery_lazyload/tree/2.x #}
<script src="{{ url_for('static', filename='lazyload.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='jquery-3.3.1.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='bootstrap.bundle.min.js') }}"></script>
<meta name="csrf-token" content="{{ csrf_token() }}">
<script type="text/javascript">
    // configure jquery ajax requests to send csrf_token as X-CSRF-Token header on POST request
    // taken from flask-wtf

    // The settings specified here will affect all calls to $.ajax or Ajax-based derivatives
    // such as $.get(). This can cause undesirable behavior since other callers (for example,
    // plugins) may be expecting the normal default settings. For that reason we strongly
    // recommend against using this API. Instead, set the options explicitly in the call
    // or define a simple plugin to do so.
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", $('meta[name="csrf-token"]').attr('content'));
            }
        },
        // after we get response and success etc was called
        complete: function(jqXHR, textStatus) {
            // get and set new token
            let new_token = jqXHR.getResponseHeader("X-CSRFToken");
            if (new_token) {
                $('meta[name="csrf-token"]').attr('content', new_token);
                // also set hidden csrf-token fields otherwise their token will be invalid
                $('input[name="_csrf_token"]').attr("value", new_token);
            }
        }
    });
</script>
<nav class="navbar navbar-expand mdb-nav dark-color">
    <a class="mdb-navbar-brand" href="#">MangaDB</a>

    <form action="{{ url_for('main.search_books') }}" method=get class="search-form">
        <i class="fa fa-search" id="search-icon"></i>
        <input type="text" class="searchbar" name ="q" placeholder="Search" value"{{ search_field }}"/>
        <input type="hidden" value="{{ order }}" name="order" />
        <input type="hidden" value="{{ sort_col }}" name="sort_col" />
    </form>
    <ul class="navbar-nav mr-auto" id="search-options">
        <li class="nav-item" style="position:relative"> {# relative so dropdown is at correct loc #}
        <a class="nav-link" href="#" role="button" id="sortDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fas fa-sort"></i></a>
        
        <div class="dropdown-menu" aria-labelledby="sortDropdown">
            <a class="dropdown-item {{ 'active' if order_col == 'id' else '' }}" data-value="id" href="#">Id</a>
            <a class="dropdown-item {{ 'active' if order_col == 'title_eng' else '' }}" data-value="title_eng" href="#">English Title</a>
            <a class="dropdown-item {{ 'active' if order_col == 'title_foreign' else '' }}" data-value="title_foreign" href="#">Foreign Title</a>
            <a class="dropdown-item {{ 'active' if order_col == 'pages' else '' }}" data-value="pages" href="#">Pages</a>
            <a class="dropdown-item {{ 'active' if order_col == 'my_rating' else '' }}" data-value="my_rating" href="#">My Rating</a>
            <a class="dropdown-item {{ 'active' if order_col == 'last_change' else '' }}" data-value="last_change" href="#">Last Change</a>
      </div>
      </li>
      <li class="nav-item">
          <a class="nav-link" href="#" id="orderLnk" data-value="{{ order }}"><i class="fas fa-sort-amount-{{ 'down' if order == 'DESC' else 'up' }}"></i></a>
      </li>
      <li class="nav-item">
          <a class="nav-link" href="#" id="refreshSearch"><i class="fas fa-sync-alt"></i></a>
      </li>
    </ul>
    <div class="mdb-nav-right">
        <a id="add-book-btn" href="{{ url_for('main.show_add_book') }}"><i class="fas fa-plus"></i></span>
        {% if "authenticated" in session %}
        <a href="{{ url_for('auth.logout') }}"><i class="fas fa-sign-out-alt"></i></a>
        {% else %}
        <a href="{{ url_for('auth.login') }}"><i class="fas fa-sign-in-alt"></i></a>
        {% endif %}
    </div>
</nav>
<div class=page>
	{% with messages = get_flashed_messages(with_categories=true) %}
		{% if messages %}
		    <div class="flash dark-color">
			<ul class="flash-messages">
			{% for category, message in messages %}
			<li class="{{ category }}">{{ message }}</li>
			{% endfor %}
			</ul>
		    </div>
		{% endif %}
	{% endwith %}
{% block body %}{% endblock %}
</div>
<script>
    $("img").on("error", function() {
        $(this).attr("src", "{{ url_for('static', filename='no-image.png') }}");
    });
</script>
